node('Win11') {
	agent {
		label 'MSYS2'
	}

	environment {
		CI = 'true'
	}

    stage('Clone sources') {
        git url: 'https://github.com/cpplibv/libv',
            branch: 'dev'
    }

    stage('Configure') {
        if (!fileExists('build/release/build.ninja')) {
            // First run proper configure
            sh "cmake --preset ninja-release"
        } else {
            // Not first run, let cmake check on itself with wish
            sh "ninja -C build/release wish"
        }
    }

    stage('Dependencies') {
        sh "ninja -C build/release wish_ext_lazy"
    }

    stage('Build star') {
        sh "ninja -C build/release star"
        sh "ninja -C build/release test_libv_algo"
        def issuesGCC = scanForIssues tool: gcc()
		publishIssues issues: [issuesGCC], name: 'GCC'
    }

    stage('Tests') {
        sh "mkdir -p report"
        sh "bin/release/test_libv_algo.exe -r junit > report/test_libv_algo.xml"
        def issuesUnit = scanForIssues tool: junitParser(pattern: 'report/**.xml')
		publishIssues issues: [issuesUnit], publishAllIssues: true, name: 'test_libv_algo'
    }

//     stage('Package') {
//         archiveArtifacts artifacts: 'bin/release/star.exe'
//     }

    stage('Archive') {
        archiveArtifacts artifacts: 'bin/release/star.exe'
    }

//     withCredentials([file(credentialsId: 'space-priv-key', variable: 'FILE')]) {
//         stage('Test Secrets') {
//             echo 'hi'
//             sh "echo 'space-private-key-test'"
//             sh 'echo "$FILE"'
//             sh 'cat "$FILE"'
//             sh 'cp "$FILE" test.txt'
//             echo 'bye'
//         }
//     }

//     stage('Parallel Stage') {
//         parallel(
//             'a': stage('Branch A') {
//                 echo "On Branch A"
//             },
//             'b': stage('Branch B') {
//                 echo "On Branch B"
//             }
//         )
//     }
}
